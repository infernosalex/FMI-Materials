@model IEnumerable<markly.ViewModels.CommentDto>
@{
    var bookmarkId = (int)ViewData["BookmarkId"]!;
    var isAuthenticated = (bool)ViewData["IsAuthenticated"]!;
    var currentUserProfilePictureUrl = ViewData["CurrentUserProfilePictureUrl"] as string;
}

<div class="comments-section mt-5" id="comments-section">
    <h5 class="fw-semibold text-secondary mb-4">
        <i class="bi bi-chat-dots me-2"></i>Comments
        <span class="badge bg-secondary-subtle text-secondary ms-2" id="comment-count">@Model.Count()</span>
    </h5>

    @if (isAuthenticated)
    {
        <div class="comment-composer mb-4" id="comment-composer">
            <div class="comment-composer__avatar">
                @if (!string.IsNullOrEmpty(currentUserProfilePictureUrl))
                {
                    <img src="@currentUserProfilePictureUrl" alt="Your avatar" class="comment-avatar-img" />
                }
                else
                {
                    <i class="bi bi-person-fill"></i>
                }
            </div>
            <div class="comment-composer__card">
                <!-- Collapsed trigger -->
                <div class="comment-composer__trigger" id="composer-trigger">
                    <span class="comment-composer__trigger-text">Share your thoughts...</span>
                </div>
                <!-- Expanded form -->
                <form id="comment-form" class="comment-composer__form" data-bookmark-id="@bookmarkId" data-user-profile-picture="@currentUserProfilePictureUrl">
                    <div class="comment-composer__textarea-wrapper">
                        <textarea id="comment-content" class="form-control comment-composer__textarea" rows="3"
                                  placeholder="What are your thoughts?" maxlength="2000"></textarea>
                    </div>
                    <div class="comment-composer__footer">
                        <span class="char-counter" id="char-counter">
                            <span id="char-count">0</span> / 2000
                        </span>
                        <div class="comment-composer__actions">
                            <button type="button" class="comment-cancel-btn" id="cancel-comment">
                                Cancel
                            </button>
                            <button type="submit" class="comment-submit-btn" id="submit-comment" disabled>
                                <span class="comment-submit-btn__text">
                                    <i class="bi bi-send-fill me-1"></i> Post
                                </span>
                                <span class="comment-submit-btn__success">
                                    <i class="bi bi-check-lg"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-light border mb-4">
            <i class="bi bi-info-circle me-2"></i>
            <a asp-controller="Account" asp-action="Login" class="alert-link">Sign in</a> to leave a comment.
        </div>
    }

    <div id="comments-list">
        @if (!Model.Any())
        {
            <div class="text-center py-5 text-muted" id="no-comments-message">
                <img src="~/images/illustrations/no-comments.svg" alt="" class="img-fluid mb-3" style="max-height: 240px;">
                <p class="mb-0">No comments yet. Be the first to share your thoughts!</p>
            </div>
        }
        else
        {
            @foreach (var comment in Model)
            {
                <partial name="_CommentItem" model="comment" />
            }
        }
    </div>
</div>
