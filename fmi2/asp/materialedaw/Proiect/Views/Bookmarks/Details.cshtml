@model BookmarkDetailsViewModel
@using System.Text.Encodings.Web
@using System.Text.RegularExpressions

@{
    ViewData["Title"] = Model.Title;
}

@functions {
    private static string Linkify(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return text;

        var urlPattern = @"(https?://[^\s]+|www\.[^\s]+)";
        var sb = new System.Text.StringBuilder();
        var lastIndex = 0;

        foreach (Match match in Regex.Matches(text, urlPattern, RegexOptions.IgnoreCase))
        {
            sb.Append(HtmlEncoder.Default.Encode(text.Substring(lastIndex, match.Index - lastIndex)));

            var rawUrl = match.Value;
            var trailing = "";
            while (rawUrl.Length > 0 && ".,);?!]".Contains(rawUrl[^1]))
            {
                trailing = rawUrl[^1] + trailing;
                rawUrl = rawUrl[..^1];
            }

            var href = rawUrl.StartsWith("www.", StringComparison.OrdinalIgnoreCase)
                ? "https://" + rawUrl
                : rawUrl;

            sb.Append($"<a href=\"{href}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-decoration-none\">{HtmlEncoder.Default.Encode(rawUrl)}</a>");
            sb.Append(HtmlEncoder.Default.Encode(trailing));

            lastIndex = match.Index + match.Length;
        }

        if (lastIndex < text.Length)
            sb.Append(HtmlEncoder.Default.Encode(text.Substring(lastIndex)));

        return sb.ToString();
    }

    private static string LinkifyWithLineBreaks(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return text;

        var linked = Linkify(text);
        // Replace both raw newlines and HTML-encoded versions (&#xD; = \r, &#xA; = \n)
        return linked
            .Replace("&#xD;&#xA;", "<br />")
            .Replace("&#xD;", "")
            .Replace("&#xA;", "<br />")
            .Replace("\r\n", "<br />")
            .Replace("\n", "<br />");
    }
}

<section class="container py-5" style="max-width: 860px;">
    <div class="mb-3">
        <a asp-controller="Home" asp-action="Index" class="text-decoration-none text-secondary">
            <i class="bi bi-arrow-left"></i> Back to Feed
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4">
            <div class="mb-4 border-bottom pb-4">
                <div>
                    @if (!Model.IsPublic)
                    {
                        <div class="mb-2">
                            <span class="badge bg-secondary">
                                Private
                            </span>
                        </div>
                    }
                    <h1 class="h3 mb-2">@Model.Title</h1>
                    <p class="text-muted fs-5 mb-2">@Html.Raw(LinkifyWithLineBreaks(Model.Description))</p>
                    <small class="text-muted d-block">
                        <i class="bi bi-person-circle me-1"></i>
                        <a href="/u/@Model.AuthorUsername" class="text-decoration-none text-muted">@Model.AuthorName</a>
                        <span class="mx-2">â€¢</span>
                        <i class="bi bi-clock me-1"></i> @Model.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <span class="ms-2 fst-italic">(Updated @Model.UpdatedAt.Value.ToLocalTime().ToString("dd MMM yyyy, HH:mm"))</span>
                        }
                    </small>
                </div>

                <div class="mt-3 d-flex justify-content-between flex-wrap gap-2 align-items-center">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="vote-btn vote-btn--large"
                                data-bookmark-id="@Model.Id"
                                data-liked="@Model.IsLikedByCurrentUser.ToString().ToLower()">
                            <i class="bi @(Model.IsLikedByCurrentUser ? "bi-heart-fill" : "bi-heart")"></i>
                            <span class="vote-count">@Model.VoteCount</span>
                        </button>
                        <button type="button" class="action-btn action-btn--large save-btn"
                                data-bookmark-id="@Model.Id">
                            <i class="bi bi-bookmark"></i>
                            <span>Save</span>
                        </button>
                        <button type="button" class="action-btn action-btn--large share-btn"
                                data-bookmark-id="@Model.Id"
                                data-bookmark-title="@Model.Title">
                            <i class="bi bi-share"></i>
                            <span>Share</span>
                        </button>
                    </div>

                    @if (Model.CanEdit)
                    {
                        <div class="d-flex gap-2 flex-wrap">
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="action-btn action-btn--large edit-btn">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <a asp-action="Delete" asp-route-id="@Model.Id" class="action-btn action-btn--large delete-btn">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    }
                </div>
            </div>

            <div class="bookmark-media">
                @if (!string.IsNullOrWhiteSpace(Model.MediaContent.TextContent))
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-secondary mb-3">
                            <i class="bi bi-journal-text me-2"></i>Notes
                        </h5>
                        <div class="p-3 bg-light rounded border border-light-subtle">
                            @Html.Raw(LinkifyWithLineBreaks(Model.MediaContent.TextContent))
                        </div>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.MediaContent.ImageUrl))
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-secondary mb-3">
                            <i class="bi bi-image me-2"></i>Image
                        </h5>
                        <div class="text-center">
                            <img src="@Model.MediaContent.ImageUrl" alt="@Model.Title" class="img-fluid rounded shadow-sm" style="max-height: 500px; object-fit: contain;" />
                        </div>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.MediaContent.VideoEmbedUrl))
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-secondary mb-3">
                            <i class="bi bi-play-btn me-2"></i>Video
                        </h5>
                        <div class="ratio ratio-16x9 rounded overflow-hidden shadow-sm">
                            <iframe src="@Model.MediaContent.VideoEmbedUrl" title="Bookmark video player" allowfullscreen
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
                        </div>
                    </div>
                }

                @if (!Model.MediaContent.HasAnyMedia)
                {
                    <div class="alert alert-light text-muted border d-flex align-items-center justify-content-center py-5" role="alert">
                        <div class="text-center">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            <span>No additional media attached.</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    @{
        ViewData["BookmarkId"] = Model.Id;
        ViewData["IsAuthenticated"] = User.Identity?.IsAuthenticated ?? false;
    }
    <partial name="_CommentsSection" model="Model.Comments" />
</section>

@section Scripts {
    <script src="~/js/shared/toast.js" asp-append-version="true"></script>
    <script src="~/js/comments.js" asp-append-version="true"></script>
}