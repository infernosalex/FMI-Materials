@model IEnumerable<markly.ViewModels.CategoryFormViewModel>

@{
    ViewData["Title"] = "My Categories";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">@ViewData["Title"]</h1>
            <p class="text-muted mb-0">Organize your bookmarks with categories</p>
        </div>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Create Category
        </a>
    </div>

    @if (Model.Any())
    {
        <!-- Search Bar -->
        <div class="mb-4">
            <div class="input-group" style="max-width: 400px;">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" id="category-search"
                    placeholder="Search categories..." autocomplete="off">
            </div>
        </div>

        <!-- Category Grid -->
        <div class="row g-4" id="category-grid">
            @foreach (var category in Model)
            {
                <div class="col-md-6 col-lg-4 category-card-wrapper" data-category-name="@category.Name.ToLower()" data-category-desc="@(category.Description?.ToLower() ?? "")">
                    <div class="category-card">
                        <!-- Stretched link to make entire card clickable -->
                        <a asp-action="Details" asp-route-id="@category.Id" class="category-card__link" aria-label="View @category.Name category"></a>

                        <!-- Preview Mosaic -->
                        @if (category.PreviewImages.Any())
                        {
                            <div class="category-card__preview">
                                <div class="category-card__preview-mosaic">
                                    @foreach (var imageUrl in category.PreviewImages.Take(4))
                                    {
                                        <div class="category-card__preview-image" style="background-image: url('@imageUrl')"></div>
                                    }
                                </div>
                                <div class="category-card__preview-overlay"></div>
                            </div>
                        }
                        else if (category.BookmarkCount > 0)
                        {
                            <div class="category-card__preview category-card__preview--empty">
                                <div class="category-card__preview-pattern"></div>
                                <div class="category-card__preview-placeholder">
                                    <i class="bi bi-file-text"></i>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="category-card__preview category-card__preview--empty">
                                <div class="category-card__preview-pattern"></div>
                                <div class="category-card__preview-placeholder">
                                    <i class="bi bi-collection"></i>
                                </div>
                            </div>
                        }

                        <!-- Card Header -->
                        <div class="category-card__header">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h3 class="category-card__title mb-0">
                                    @category.Name
                                </h3>
                                @if (category.IsPublic)
                                {
                                    <span class="badge bg-success-subtle text-success">
                                        <i class="bi bi-globe"></i> Public
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary-subtle text-secondary">
                                        <i class="bi bi-lock"></i> Private
                                    </span>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(category.Description))
                            {
                                <p class="category-card__description">@category.Description</p>
                            }
                        </div>

                        <!-- Card Body -->
                        <div class="category-card__body">
                            <div class="category-card__stats">
                                <div class="category-card__stat">
                                    <i class="bi bi-bookmarks text-purple"></i>
                                    <span class="ms-1">@category.BookmarkCount bookmark@(category.BookmarkCount != 1 ? "s" : "")</span>
                                </div>
                                @if (category.CreatedAt.HasValue)
                                {
                                    <div class="category-card__stat">
                                        <i class="bi bi-calendar-event"></i>
                                        <span class="ms-1">@category.CreatedAt.Value.ToString("MMM dd, yyyy")</span>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Card Footer -->
                        <div class="category-card__footer">
                            @if (category.PreviewImages.Any())
                            {
                                <div class="category-card__thumbnails">
                                    @foreach (var imageUrl in category.PreviewImages.Take(4))
                                    {
                                        <div class="category-card__thumbnail" style="background-image: url('@imageUrl')"></div>
                                    }
                                    @if (category.BookmarkCount > 4)
                                    {
                                        <div class="category-card__thumbnail category-card__thumbnail--more">
                                            +@(category.BookmarkCount - 4)
                                        </div>
                                    }
                                </div>
                            }
                            <div class="category-card__actions">
                                <a asp-action="Edit" asp-route-id="@category.Id" class="btn btn-sm btn-outline-secondary" aria-label="Edit @category.Name">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@category.Id" class="btn btn-sm btn-outline-danger" aria-label="Delete @category.Name">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- No Results Message (Hidden by default) -->
        <div id="no-results" class="alert alert-info mt-4" style="display: none;">
            <i class="bi bi-search"></i> No categories match your search.
        </div>
    }
    else
    {
        <!-- Empty State -->
        <div class="category-empty-state text-center py-5">
            <div class="category-empty-icon mb-4">
                <i class="bi bi-folder-plus"></i>
            </div>
            <h3 class="mb-3">No categories yet</h3>
            <p class="text-muted mb-4">
                Categories help you organize your bookmarks into collections.<br>
                Create your first category to get started!
            </p>
            <a asp-action="Create" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-lg"></i> Create Your First Category
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('category-search');
            if (!searchInput) return;

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const categoryCards = document.querySelectorAll('.category-card-wrapper');
                const noResults = document.getElementById('no-results');
                let visibleCount = 0;

                categoryCards.forEach(card => {
                    const name = card.getAttribute('data-category-name') || '';
                    const desc = card.getAttribute('data-category-desc') || '';
                    const matchesSearch = name.includes(searchTerm) || desc.includes(searchTerm);

                    if (matchesSearch) {
                        card.style.display = '';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Show/hide no results message
                if (visibleCount === 0 && searchTerm !== '') {
                    noResults.style.display = 'block';
                } else {
                    noResults.style.display = 'none';
                }
            });
        });
    </script>
}
