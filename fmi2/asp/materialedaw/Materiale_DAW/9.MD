# Dezvoltarea Aplicațiilor Web utilizând ASP.NET Core MVC

**Curs 9**

---

## Cuprins

| Subiect | Pagina |
| --- | --- |
| Sistemul de autentificare. Identity Framework | 2 

 |
| ASP.NET Core Identity | 3 

 |
| Crearea unui proiect integrând Identity Framework | 5 

 |
| Roluri. Asocierea dintre roluri și utilizatori | 21 

 |
| Atributul `[Authorize]` | 21 

 |
| Implementare New, Edit și Delete utilizând roluri | 24 

 |
| Stocarea fișierelor în baza de date | 24 

 |

---

## Sistemul de Autentificare

Framework-ul ASP.NET Core permite integrarea unui sistem de autentificare prin intermediul **Identity Framework**. Acesta este un sub-framework integrat cu Entity Framework Core pentru operațiunile de bază de date.

### Caracteristici Identity Framework:

* 
**Autentificare complexă:** Permite utilizarea combinației user/parolă sau conturi third-party (Google, Facebook, Twitter etc.).


* 
**Managementul Rolurilor:** Include posibilitatea creării și manipulării rolurilor utilizatorilor.


* 
**Stocare:** Utilizează **SQL Server** pentru stocarea utilizatorilor, rolurilor și asocierilor dintre aceștia.



---

## ASP.NET Core Identity

Pentru a genera un proiect cu Identity, trebuie selectată opțiunea **Individual Accounts** la crearea proiectului. Această opțiune permite utilizatorilor să își creeze propriile conturi stocate în baza de date a aplicației.

### Beneficii:

* 
**Securitate:** Implementează hashing-ul pentru protejarea parolelor.


* 
**Integrare externă:** Suport pentru servicii third-party.


* 
**Autorizare:** Sistem de roluri și permisiuni integrat.


* 
**Interfață:** Management ușor pentru adăugarea, editarea sau ștergerea utilizatorilor.



---

## Crearea unui proiect integrând Identity Framework

### Instrucțiuni pe Platforme:

* 
**Windows:** Se utilizează template-ul *ASP.NET Core Web App (Model-View-Controller)* și se selectează *Individual Accounts*.


* **MAC și Linux:** Se utilizează comanda:


`dotnet new webapp --auth Individual -o NumeProiect`.



### Pachete necesare (Terminal):

```bash
dotnet tool install --global dotnet-ef --version 9.0.11
dotnet add package Pomelo.EntityFrameworkCore.MySql
dotnet add package Microsoft.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.Design
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore

```



---

## Roluri. Asocierea dintre roluri și utilizatori

### Structura Bazei de Date (Exemplu: Engine de știri)

Diagrama entităților include:

* 
**USERS:** `user_id` (PK), `user_name`, `pass`.


* 
**ROLES:** `role_id` (PK), `role_name`.


* 
**USER_IN_ROLE:** Tabel de legătură între utilizatori și roluri.


* 
**ARTICLES, COMMENTS, CATEGORIES:** Entități corelate cu utilizatorii prin chei externe (`user_id`).



### Pași pentru Configurarea Rolurilor:

**PASUL 1: Extinderea clasei User**
Se creează o clasă `ApplicationUser` în folderul `Models` care moștenește `IdentityUser`.

```csharp
public class ApplicationUser : IdentityUser 
{
    // Se pot adăuga atribute suplimentare (data nașterii, bio, etc.)
}

```



**PASUL 2: Adăugarea serviciilor în `Program.cs**`
Este necesară adăugarea serviciului de management al rolurilor: `.AddRoles<IdentityRole>()`.

**PASUL 3: Modificarea Contextului Bazei de Date**
Clasa `ApplicationDbContext` trebuie să moștenească `IdentityDbContext<ApplicationUser>`.

**PASUL 4 & 5: Popularea Bazei de Date (SeedData)**
Se creează o clasă `SeedData` cu o metodă `Initialize` pentru a insera rolurile implicite (Admin, Editor, User) și utilizatorii inițiali. Aceasta se apelează în `Program.cs` folosind un scope temporar de servicii.

**PASUL 9: Atribuirea rolului la înregistrare**
În codul sursă generat prin *Scaffolding* pentru pagina de înregistrare, se adaugă:


`await _userManager.AddToRoleAsync(user, "User");`.

---

## Atributul `[Authorize]`

Se utilizează pentru a restricționa accesul la metodele unui Controller.

* 
**Exemplu:** `[Authorize(Roles = "User, Editor, Admin")]` permite accesul doar utilizatorilor cu acele roluri specifice.



---

## Implementare New, Edit și Delete

În cadrul metodelor CRUD, acțiunile sunt limitate pe baza identității:

* 
**Adăugare:** Se preia ID-ul utilizatorului curent folosind `_userManager.GetUserId(User)`.


* 
**Editare/Ștergere:** Se verifică dacă articolul aparține utilizatorului sau dacă acesta are rolul de **Admin** folosind `User.IsInRole("Admin")`.



---

## Stocarea fișierelor în baza de date

Pentru a salva imagini/video asociate articolelor:

1. 
**Model:** Se adaugă o proprietate `string Image` pentru a salva calea fișierului.


2. 
**View:** Formularul trebuie să aibă `enctype="multipart/form-data"` și un input de tip `file`.


3. **Controller:**
* Se injectează `IWebHostEnvironment` pentru a accesa folderul `wwwroot`.


* Se verifică extensiile permise (ex: .jpg, .png, .mp4).


* Fișierul se salvează fizic în `wwwroot/images`, iar calea este salvată în baza de date.


* Se utilizează `ModelState.Remove` și `TryValidateModel` pentru a revalida modelul după actualizarea căii imaginii.


# Dezvoltarea Aplicațiilor Web utilizând ASP.NET Core MVC

**Laborator 9**

---

## Exerciții

### 1. Implementarea Sistemului de Autentificare

Pornind de la versiunea din laboratorul anterior, implementați sistemul de autentificare și asocierea dintre roluri și utilizatori, urmând toți pașii descriși în **Cursul 9**.

### 2. Cerințe Funcționale pentru Aplicație

Aplicația trebuie să îndeplinească următoarele specificații:

* 
**Tipuri de utilizatori**: Trebuie să existe cel puțin 4 tipuri: vizitator neînregistrat, utilizator înregistrat, editor și administrator.


* **Vizualizarea știrilor**:
* Orice utilizator poate vizualiza știrile.


* Pagina principală va afișa cele mai recente  știri, ordonate după data postării.


* Știrile vor fi afișate paginat.




* 
**Categorii**: Știrile sunt împărțite pe categorii (ex: știință, tehnologie, sport) create dinamic de către administrator, care are drepturi de CRUD pe acestea.


* 
**Editor de text**: Publicarea știrilor noi va include un editor de text ce permite utilizarea elementelor de markup.


* 
**Motor de căutare**: Știrile pot fi căutate după titlu, conținut sau conținutul comentariilor.


* **Restricții de acces**:
* Utilizatorii fără cont pot vedea doar pagina principală; orice altă interacțiune necesită redirecționarea către pagina de înregistrare/autentificare.


* Administratorii pot activa sau revoca drepturile utilizatorilor și editorilor.





---

## Proiectarea și Structura Datelor

### Diagrama Conceptuală a Bazei de Date

Structura include următoarele entități și relații:

* 
**USERS**: `user_id` (PK), `user_name`, `pass`.


* 
**ROLES**: `role_id` (PK), `role_name`.


* 
**USER_IN_ROLE**: Tabel de legătură (Many-to-Many) între utilizatori și roluri.


* 
**ARTICLES**: `article_id` (PK), `title`, `content`, `date`, `user_id` (FK), `category_id` (FK).


* 
**COMMENTS**: `comm_id` (PK), `text`, `date`, `article_id` (FK), `user_id` (FK).


* 
**CATEGORIES**: `categ_id` (PK), `category_name`.



---

## Implementare - Modificări pe Entități

### Entitatea Article

* 
**Index**: Permite preluarea tuturor articolelor și a categoriilor lor. Accesul este restricționat utilizatorilor înregistrați (`[Authorize]`). Trebuie afișat și utilizatorul care a publicat articolul.


* 
**Show**: Afișează un singur articol cu detaliile complete (autor, categorie). Toate rolurile autentificate au acces.


* 
**New**: Permis doar pentru **Editor** și **Admin**. La salvare (POST), se reține ID-ul utilizatorului care postează.


* **Edit & Delete**:
* 
**Editorii** pot edita/șterge doar propriile știri.


* 
**Adminii** pot edita/șterge orice articol.


* Utilizatorii neautorizați vor primi un mesaj de eroare corespunzător.





### Entitatea Category

* Doar utilizatorii cu rolul **Admin** pot efectua operațiuni CRUD pe categorii.



### Entitatea Comment

* Toți utilizatorii autentificați pot adăuga comentarii.


* Utilizatorii pot edita/șterge doar comentariile proprii; **Administratorul** le poate gestiona pe toate.



---

## Interfața Utilizator (View-uri)

### Personalizarea Meniului (`_Layout.cshtml`)

Link-urile din meniu vor fi vizibile în funcție de rol:

* 
**User**: Vede doar "Afișare articole".


* 
**Editor**: Vede "Afișare articole" și "Adăugare articol".


* 
**Admin**: Vede "Afișare articole", "Adăugare articol" și "Afișare categorii".



Se utilizează verificări de tipul:


`@if (User.IsInRole("Admin")) { ... }`.

### Butoanele de Control în `Show`

Butoanele de **Editare** și **Ștergere** trebuie să fie vizibile doar pentru Admin (pentru orice articol) și pentru Editor (doar pentru articolele proprii). Utilizatorul cu rolul **User** nu va vedea aceste butoane.

---

## Observație Tehnică

Clasa `ApplicationUser` (care moștenește `IdentityUser`) trebuie să definească colecțiile pentru relațiile cu celelalte entități:

```csharp
public virtual ICollection<Comment>? Comments { get; set; [cite_start]} [cite: 887]
public virtual ICollection<Article>? Articles { get; set; [cite_start]} [cite: 888]

```

Would you like me to provide a code snippet for implementing the conditional visibility of the Edit and Delete buttons in the `Show.cshtml` view?